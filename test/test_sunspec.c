#include <assert.h>
#include <setjmp.h>
#include <stdlib.h>
#include <stdio.h>
#include <string.h>

#include "CuTest.h"

#include "sunspec.h"
#include "sunspec_device.h"
#include "sunspec_log.h"

#include "inverter.h"

uint16_t test_device[] = {
    0x5375, 0x6e53,                 /* SunS */
    /* model 1 */
    1, 66,
    0x5375, 0x6e53, 0x7065, 0x6354, 0x6573, 0x7400, 0x0000, 0x0000,    /* Mn - SunSpecTest */
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
    0x5465, 0x7374, 0x496e, 0x7665, 0x7274, 0x6572, 0x0000, 0x0000,    /* Md - TestInverter */
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
    0x6f70, 0x745f, 0x615f, 0x625f, 0x6300, 0x0000, 0x0000, 0x0000,    /* Opt - opt_a_b_c */
    0x312e, 0x322e, 0x3300, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,    /* Vr - 1.2.3 */
    0x736e, 0x2d31, 0x3233, 0x3435, 0x3637, 0x3839, 0x0000, 0x0000,    /* SN - sn-123456789 */
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
    0x0001,
    -32768,                         /* Pad */
    /* model 101 */
    101, 50,
    549,                            /* A */
    549,                            /* AphA */
    65535,                          /* AphB */
    65535,                          /* AphC */
    -2,                             /* A_SF */
    65535,                          /* PPVphAB */
    65535,                          /* PPVphBC */
    65535,                          /* PPVphCA */
    243,                            /* PhVphA */
    65535,                          /* PhVphB */
    65535,                          /* PhVphC */
    0,                              /* V_SF */
    1307,                           /* W */
    0,                              /* W_SF */
    6001,                           /* Hz */
    -2,                             /* Hz_SF */
    1334,                           /* VA */
    0,                              /* VA_SF */
    267,                            /* VAr */
    0,                              /* VAr_SF */
    979,                            /* PF */
    -3,                             /* PF_SF */
    0x001a, 0x4287,                 /* WH  (1720967) */
    0,                              /* WH_SF */
    380,                            /* DCA */
    -2,                             /* DCA_SF */
    350,                            /* DCV */
    0,                              /* DCV_SF */
    13300,                          /* DCW */
    -1,                             /* DCW_SF */
    -32768,                         /* TmpCab */
    -32768,                         /* TmpSnk */
    -32768,                         /* TmpTrns */
    -32768,                         /* TmpOt */
    -32768,                         /* Tmp_SF */
    4,                              /* St */
    4,                              /* StVnd */
    0x0000, 0x0000,                 /* Evt1  (0) */
    0x0000, 0x0000,                 /* Evt2  (0) */
    0x0000, 0x0000,                 /* EvtVnd1  (0) */
    0x0000, 0x0000,                 /* EvtVnd2  (0) */
    0x0000, 0x0000,                 /* EvtVnd3  (0) */
    0x0000, 0x0000,                 /* EvtVnd4  (0) */
    /* model 120 */
    120, 26,
    4,                              /* DERTyp */
    7500,                           /* WRtg */
    0,                              /* WRtg_SF */
    7500,                           /* VARtg */
    0,                              /* VARtg_SF */
    400,                            /* VArRtgQ1 */
    -32768,                         /* VArRtgQ2 */
    -32768,                         /* VArRtgQ3 */
    -400,                           /* VArRtgQ4 */
    1,                              /* VArRtg_SF */
    3130,                           /* ARtg */
    -2,                             /* ARtg_SF */
    -850,                           /* PFRtgQ1 */
    -32768,                         /* PFRtgQ2 */
    -32768,                         /* PFRtgQ3 */
    850,                            /* PFRtgQ4 */
    -3,                             /* PFRtg_SF */
    65535,                          /* WHRtg */
    -32768,                         /* WHRtg_SF */
    65535,                          /* AhrRtg */
    -32768,                         /* AhrRtg_SF */
    65535,                          /* MaxChaRte */
    -32768,                         /* MaxChaRte_SF */
    65535,                          /* MaxDisChaRte */
    -32768,                         /* MaxDisChaRte_SF */
    -32768,                         /* Pad */
    /* model 121 */
    121, 30,
    7500,                           /* WMax */
    240,                            /* VRef */
    0,                              /* VRefOfs */
    269,                            /* VMax */
    206,                            /* VMin */
    7500,                           /* VAMax */
    400,                            /* VArMaxQ1 */
    -32768,                         /* VArMaxQ2 */
    -32768,                         /* VArMaxQ3 */
    -400,                           /* VArMaxQ4 */
    1000,                            /* WGra */
    -850,                           /* PFMinQ1 */
    -32768,                         /* PFMinQ2 */
    -32768,                         /* PFMinQ3 */
    850,                            /* PFMinQ4 */
    65535,                          /* VArAct */
    65535,                          /* ClcTotVA */
    65535,                          /* MaxRmpRte */
    65535,                          /* ECPNomHz */
    65535,                          /* ConnPh */
    0,                              /* WMax_SF */
    0,                              /* VRef_SF */
    0,                              /* VRefOfs_SF */
    0,                              /* VMinMax_SF */
    0,                              /* VAMax_SF */
    1,                              /* VArMax_SF */
    -1,                             /* WGra_SF (-32768) */
    -3,                             /* PFMin_SF */
    -32768,                         /* MaxRmpRte_SF */
    -32768,                         /* ECPNomHz_SF */
    /* model 122 */
    122, 44,
    7,                              /* PVConn */
    0,                              /* StorConn */
    1,                              /* ECPConn */
    0x0000, 0x0000, 0x001a, 0x4287, /* ActWh  (1720967) */
    0x0000, 0x0000, 0x0000, 0x0000, /* ActVAh  (0) */
    0x0000, 0x0000, 0x0000, 0x0000, /* ActVArhQ1  (0) */
    0x0000, 0x0000, 0x0000, 0x0000, /* ActVArhQ2  (0) */
    0x0000, 0x0000, 0x0000, 0x0000, /* ActVArhQ3  (0) */
    0x0000, 0x0000, 0x0000, 0x0000, /* ActVArhQ4  (0) */
    -32768,                         /* VArAval */
    -32768,                         /* VArAval_SF */
    65535,                          /* WAval */
    -32768,                         /* WAval_SF */
    0xffff, 0xffff,                 /* StSetLimMsk  (4294967295) */
    0x0000, 0x0000,                 /* StActCtl  (0) */
    0x5254, 0x4300, 0x0000, 0x0000,     /* TmSrc - RTC */
    0x0000, 0x0000,                 /* Tms  (0) */
    65535,                          /* RtSt */
    0,                              /* Ris */
    0,                              /* Ris_SF */
    /* model 123 */
    123, 24,
    0,                              /* Conn_WinTms */
    0,                              /* Conn_RvrtTms */
    1,                              /* Conn */
    100,                            /* WMaxLimPct */
    0,                              /* WMaxLimPct_WinTms */
    0,                              /* WMaxLimPct_RvrtTms */
    0,                              /* WMaxLimPct_RmpTms */
    0,                              /* WMaxLim_Ena */
    900,                              /* OutPFSet */
    0,                              /* OutPFSet_WinTms */
    0,                              /* OutPFSet_RvrtTms */
    0,                              /* OutPFSet_RmpTms */
    0,                              /* OutPFSet_Ena */
    -32768,                         /* VArWMaxPct */
    0,                              /* VArMaxPct */
    -32768,                         /* VArAvalPct */
    0,                              /* VArPct_WinTms */
    0,                              /* VArPct_RvrtTms */
    0,                              /* VArPct_RmpTms */
    2,                              /* VArPct_Mod */
    0,                              /* VArPct_Ena */
    0,                              /* WMaxLimPct_SF */
    -3,                             /* OutPFSet_SF */
    0,                              /* VArPct_SF */
    /* model 126 */
    126, 226,
    1,                              /* ActCrv */
    0,                              /* ModEna */
    400,                            /* WinTms */
    500,                            /* RvrtTms */
    600,                            /* RmpTms */
    4,                              /* NCrv */
    4,                              /* NPt */
    0,                              /* V_SF */
    0,                              /* DeptRef_SF */
    1,                              /* RmpIncDec_SF */
    4,                              /* ActPt */
    2,                              /* DeptRef */
    94,                             /* V1 */
    100,                            /* VAr1 */
    98,                             /* V2 */
    0,                              /* VAr2 */
    102,                            /* V3 */
    0,                              /* VAr3 */
    105,                            /* V4 */
    -100,                           /* VAr4 */
    65535,                          /* V5 */
    -32768,                         /* VAr5 */
    65535,                          /* V6 */
    -32768,                         /* VAr6 */
    65535,                          /* V7 */
    -32768,                         /* VAr7 */
    65535,                          /* V8 */
    -32768,                         /* VAr8 */
    65535,                          /* V9 */
    -32768,                         /* VAr9 */
    65535,                          /* V10 */
    -32768,                         /* VAr10 */
    65535,                          /* V11 */
    -32768,                         /* VAr11 */
    65535,                          /* V12 */
    -32768,                         /* VAr12 */
    65535,                          /* V13 */
    -32768,                         /* VAr13 */
    65535,                          /* V14 */
    -32768,                         /* VAr14 */
    65535,                          /* V15 */
    -32768,                         /* VAr15 */
    65535,                          /* V16 */
    -32768,                         /* VAr16 */
    65535,                          /* V17 */
    -32768,                         /* VAr17 */
    65535,                          /* V18 */
    -32768,                         /* VAr18 */
    65535,                          /* V19 */
    -32768,                         /* VAr19 */
    65535,                          /* V20 */
    -32768,                         /* VAr20 */
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,     /* CrvNam -  */
    65535,                          /* RmpTms */
    0,                              /* RmpDecTmm */
    0,                              /* RmpIncTmm */
    0,                              /* ReadOnly */
    4,                              /* ActPt */
    2,                              /* DeptRef */
    95,                             /* V1 */
    100,                            /* VAr1 */
    98,                             /* V2 */
    0,                              /* VAr2 */
    102,                            /* V3 */
    0,                              /* VAr3 */
    105,                            /* V4 */
    -100,                           /* VAr4 */
    65535,                          /* V5 */
    -32768,                         /* VAr5 */
    65535,                          /* V6 */
    -32768,                         /* VAr6 */
    65535,                          /* V7 */
    -32768,                         /* VAr7 */
    65535,                          /* V8 */
    -32768,                         /* VAr8 */
    65535,                          /* V9 */
    -32768,                         /* VAr9 */
    65535,                          /* V10 */
    -32768,                         /* VAr10 */
    65535,                          /* V11 */
    -32768,                         /* VAr11 */
    65535,                          /* V12 */
    -32768,                         /* VAr12 */
    65535,                          /* V13 */
    -32768,                         /* VAr13 */
    65535,                          /* V14 */
    -32768,                         /* VAr14 */
    65535,                          /* V15 */
    -32768,                         /* VAr15 */
    65535,                          /* V16 */
    -32768,                         /* VAr16 */
    65535,                          /* V17 */
    -32768,                         /* VAr17 */
    65535,                          /* V18 */
    -32768,                         /* VAr18 */
    65535,                          /* V19 */
    -32768,                         /* VAr19 */
    65535,                          /* V20 */
    -32768,                         /* VAr20 */
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,     /* CrvNam -  */
    330,                            /* RmpTms */
    44,                             /* RmpDecTmm */
    55,                             /* RmpIncTmm */
    1,                              /* ReadOnly */
    4,                              /* ActPt */
    2,                              /* DeptRef */
    93,                             /* V1 */
    100,                            /* VAr1 */
    98,                             /* V2 */
    0,                              /* VAr2 */
    102,                            /* V3 */
    0,                              /* VAr3 */
    108,                            /* V4 */
    -100,                           /* VAr4 */
    65535,                          /* V5 */
    -32768,                         /* VAr5 */
    65535,                          /* V6 */
    -32768,                         /* VAr6 */
    65535,                          /* V7 */
    -32768,                         /* VAr7 */
    65535,                          /* V8 */
    -32768,                         /* VAr8 */
    65535,                          /* V9 */
    -32768,                         /* VAr9 */
    65535,                          /* V10 */
    -32768,                         /* VAr10 */
    65535,                          /* V11 */
    -32768,                         /* VAr11 */
    65535,                          /* V12 */
    -32768,                         /* VAr12 */
    65535,                          /* V13 */
    -32768,                         /* VAr13 */
    65535,                          /* V14 */
    -32768,                         /* VAr14 */
    65535,                          /* V15 */
    -32768,                         /* VAr15 */
    65535,                          /* V16 */
    -32768,                         /* VAr16 */
    65535,                          /* V17 */
    -32768,                         /* VAr17 */
    65535,                          /* V18 */
    -32768,                         /* VAr18 */
    65535,                          /* V19 */
    -32768,                         /* VAr19 */
    65535,                          /* V20 */
    -32768,                         /* VAr20 */
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,     /* CrvNam -  */
    65535,                          /* RmpTms */
    0,                              /* RmpDecTmm */
    0,                              /* RmpIncTmm */
    0,                              /* ReadOnly */
    4,                              /* ActPt */
    2,                              /* DeptRef */
    90,                             /* V1 */
    100,                            /* VAr1 */
    100,                            /* V2 */
    0,                              /* VAr2 */
    103,                            /* V3 */
    -50,                            /* VAr3 */
    110,                            /* V4 */
    -100,                           /* VAr4 */
    65535,                          /* V5 */
    -32768,                         /* VAr5 */
    65535,                          /* V6 */
    -32768,                         /* VAr6 */
    65535,                          /* V7 */
    -32768,                         /* VAr7 */
    65535,                          /* V8 */
    -32768,                         /* VAr8 */
    65535,                          /* V9 */
    -32768,                         /* VAr9 */
    65535,                          /* V10 */
    -32768,                         /* VAr10 */
    65535,                          /* V11 */
    -32768,                         /* VAr11 */
    65535,                          /* V12 */
    -32768,                         /* VAr12 */
    65535,                          /* V13 */
    -32768,                         /* VAr13 */
    65535,                          /* V14 */
    -32768,                         /* VAr14 */
    65535,                          /* V15 */
    -32768,                         /* VAr15 */
    65535,                          /* V16 */
    -32768,                         /* VAr16 */
    65535,                          /* V17 */
    -32768,                         /* VAr17 */
    65535,                          /* V18 */
    -32768,                         /* VAr18 */
    65535,                          /* V19 */
    -32768,                         /* VAr19 */
    65535,                          /* V20 */
    -32768,                         /* VAr20 */
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,     /* CrvNam -  */
    65535,                          /* RmpTms */
    0,                              /* RmpDecTmm */
    0,                              /* RmpIncTmm */
    0,                              /* ReadOnly */
    /* model 131 */
    131, 226,
    0,                              /* ActCrv */
    0,                              /* ModEna */
    0,                              /* WinTms */
    0,                              /* RvrtTms */
    65535,                          /* RmpTms */
    4,                              /* NCrv */
    4,                              /* NPt */
    0,                              /* W_SF */
    -3,                             /* PF_SF */
    0,                              /* RmpIncDec_SF */
    4,                              /* ActPt */
    0,                              /* W1 */
    930,                            /* PF1 */
    10,                             /* W2 */
    940,                            /* PF2 */
    90,                             /* W3 */
    950,                            /* PF3 */
    100,                            /* W4 */
    960,                            /* PF4 */
    -32768,                         /* W5 */
    -32768,                         /* PF5 */
    -32768,                         /* W6 */
    -32768,                         /* PF6 */
    -32768,                         /* W7 */
    -32768,                         /* PF7 */
    -32768,                         /* W8 */
    -32768,                         /* PF8 */
    -32768,                         /* W9 */
    -32768,                         /* PF9 */
    -32768,                         /* W10 */
    -32768,                         /* PF10 */
    -32768,                         /* W11 */
    -32768,                         /* PF11 */
    -32768,                         /* W12 */
    -32768,                         /* PF12 */
    -32768,                         /* W13 */
    -32768,                         /* PF13 */
    -32768,                         /* W14 */
    -32768,                         /* PF14 */
    -32768,                         /* W15 */
    -32768,                         /* PF15 */
    -32768,                         /* W16 */
    -32768,                         /* PF16 */
    -32768,                         /* W17 */
    -32768,                         /* PF17 */
    -32768,                         /* W18 */
    -32768,                         /* PF18 */
    -32768,                         /* W19 */
    -32768,                         /* PF19 */
    -32768,                         /* W20 */
    -32768,                         /* PF20 */
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,     /* CrvNam -  */
    65535,                          /* RmpPT1Tms */
    1400,                           /* RmpDecTmm */
    1400,                           /* RmpIncTmm */
    0,                              /* ReadOnly */
    -32768,                         /* Pad */
    4,                              /* ActPt */
    0,                              /* W1 */
    930,                            /* PF1 */
    10,                             /* W2 */
    940,                            /* PF2 */
    90,                             /* W3 */
    950,                            /* PF3 */
    100,                            /* W4 */
    960,                            /* PF4 */
    -32768,                         /* W5 */
    -32768,                         /* PF5 */
    -32768,                         /* W6 */
    -32768,                         /* PF6 */
    -32768,                         /* W7 */
    -32768,                         /* PF7 */
    -32768,                         /* W8 */
    -32768,                         /* PF8 */
    -32768,                         /* W9 */
    -32768,                         /* PF9 */
    -32768,                         /* W10 */
    -32768,                         /* PF10 */
    -32768,                         /* W11 */
    -32768,                         /* PF11 */
    -32768,                         /* W12 */
    -32768,                         /* PF12 */
    -32768,                         /* W13 */
    -32768,                         /* PF13 */
    -32768,                         /* W14 */
    -32768,                         /* PF14 */
    -32768,                         /* W15 */
    -32768,                         /* PF15 */
    -32768,                         /* W16 */
    -32768,                         /* PF16 */
    -32768,                         /* W17 */
    -32768,                         /* PF17 */
    -32768,                         /* W18 */
    -32768,                         /* PF18 */
    -32768,                         /* W19 */
    -32768,                         /* PF19 */
    -32768,                         /* W20 */
    -32768,                         /* PF20 */
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,     /* CrvNam -  */
    65535,                          /* RmpPT1Tms */
    1400,                           /* RmpDecTmm */
    1400,                           /* RmpIncTmm */
    0,                              /* ReadOnly */
    -32768,                         /* Pad */
    4,                              /* ActPt */
    0,                              /* W1 */
    930,                            /* PF1 */
    10,                             /* W2 */
    940,                            /* PF2 */
    90,                             /* W3 */
    950,                            /* PF3 */
    100,                            /* W4 */
    960,                            /* PF4 */
    -32768,                         /* W5 */
    -32768,                         /* PF5 */
    -32768,                         /* W6 */
    -32768,                         /* PF6 */
    -32768,                         /* W7 */
    -32768,                         /* PF7 */
    -32768,                         /* W8 */
    -32768,                         /* PF8 */
    -32768,                         /* W9 */
    -32768,                         /* PF9 */
    -32768,                         /* W10 */
    -32768,                         /* PF10 */
    -32768,                         /* W11 */
    -32768,                         /* PF11 */
    -32768,                         /* W12 */
    -32768,                         /* PF12 */
    -32768,                         /* W13 */
    -32768,                         /* PF13 */
    -32768,                         /* W14 */
    -32768,                         /* PF14 */
    -32768,                         /* W15 */
    -32768,                         /* PF15 */
    -32768,                         /* W16 */
    -32768,                         /* PF16 */
    -32768,                         /* W17 */
    -32768,                         /* PF17 */
    -32768,                         /* W18 */
    -32768,                         /* PF18 */
    -32768,                         /* W19 */
    -32768,                         /* PF19 */
    -32768,                         /* W20 */
    -32768,                         /* PF20 */
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,     /* CrvNam -  */
    65535,                          /* RmpPT1Tms */
    1400,                           /* RmpDecTmm */
    1400,                           /* RmpIncTmm */
    0,                              /* ReadOnly */
    -32768,                         /* Pad */
    4,                              /* ActPt */
    0,                              /* W1 */
    930,                            /* PF1 */
    10,                             /* W2 */
    940,                            /* PF2 */
    90,                             /* W3 */
    950,                            /* PF3 */
    100,                            /* W4 */
    960,                            /* PF4 */
    -32768,                         /* W5 */
    -32768,                         /* PF5 */
    -32768,                         /* W6 */
    -32768,                         /* PF6 */
    -32768,                         /* W7 */
    -32768,                         /* PF7 */
    -32768,                         /* W8 */
    -32768,                         /* PF8 */
    -32768,                         /* W9 */
    -32768,                         /* PF9 */
    -32768,                         /* W10 */
    -32768,                         /* PF10 */
    -32768,                         /* W11 */
    -32768,                         /* PF11 */
    -32768,                         /* W12 */
    -32768,                         /* PF12 */
    -32768,                         /* W13 */
    -32768,                         /* PF13 */
    -32768,                         /* W14 */
    -32768,                         /* PF14 */
    -32768,                         /* W15 */
    -32768,                         /* PF15 */
    -32768,                         /* W16 */
    -32768,                         /* PF16 */
    -32768,                         /* W17 */
    -32768,                         /* PF17 */
    -32768,                         /* W18 */
    -32768,                         /* PF18 */
    -32768,                         /* W19 */
    -32768,                         /* PF19 */
    -32768,                         /* W20 */
    -32768,                         /* PF20 */
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,     /* CrvNam -  */
    65535,                          /* RmpPT1Tms */
    1400,                           /* RmpDecTmm */
    1400,                           /* RmpIncTmm */
    0,                              /* ReadOnly */
    -32768,                         /* Pad */

    /* model 132 */
    132, 226,
    1,                              /* ActCrv */
    0,                              /* ModEna */
    402,                            /* WinTms */
    502,                            /* RvrtTms */
    602,                            /* RmpTms */
    4,                              /* NCrv */
    3,                              /* NPt */
    -1,                             /* V_SF */
    0,                              /* DeptRef_SF */
    0,                              /* RmpIncDec_SF */
    3,                              /* ActPt */
    2,                              /* DeptRef */
    950,                            /* V1 */
    100,                            /* W1 */
    1000,                           /* V2 */
    100,                            /* W2 */
    1100,                           /* V3 */
    0,                              /* W3 */
    65535,                          /* V4 */
    -32768,                         /* W4 */
    65535,                          /* V5 */
    -32768,                         /* W5 */
    65535,                          /* V6 */
    -32768,                         /* W6 */
    65535,                          /* V7 */
    -32768,                         /* W7 */
    65535,                          /* V8 */
    -32768,                         /* W8 */
    65535,                          /* V9 */
    -32768,                         /* W9 */
    65535,                          /* V10 */
    -32768,                         /* W10 */
    65535,                          /* V11 */
    -32768,                         /* W11 */
    65535,                          /* V12 */
    -32768,                         /* W12 */
    65535,                          /* V13 */
    -32768,                         /* W13 */
    65535,                          /* V14 */
    -32768,                         /* W14 */
    65535,                          /* V15 */
    -32768,                         /* W15 */
    65535,                          /* V16 */
    -32768,                         /* W16 */
    65535,                          /* V17 */
    -32768,                         /* W17 */
    65535,                          /* V18 */
    -32768,                         /* W18 */
    65535,                          /* V19 */
    -32768,                         /* W19 */
    65535,                          /* V20 */
    -32768,                         /* W20 */
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,     /* CrvNam -  */
    65535,                          /* RmpPt1Tms */
    0,                              /* RmpDecTmm */
    0,                              /* RmpIncTmm */
    0,                              /* ReadOnly */
    3,                              /* ActPt */
    2,                              /* DeptRef */
    1000,                           /* V1 */
    100,                            /* W1 */
    1100,                           /* V2 */
    100,                            /* W2 */
    1130,                           /* V3 */
    0,                              /* W3 */
    65535,                          /* V4 */
    -32768,                         /* W4 */
    65535,                          /* V5 */
    -32768,                         /* W5 */
    65535,                          /* V6 */
    -32768,                         /* W6 */
    65535,                          /* V7 */
    -32768,                         /* W7 */
    65535,                          /* V8 */
    -32768,                         /* W8 */
    65535,                          /* V9 */
    -32768,                         /* W9 */
    65535,                          /* V10 */
    -32768,                         /* W10 */
    65535,                          /* V11 */
    -32768,                         /* W11 */
    65535,                          /* V12 */
    -32768,                         /* W12 */
    65535,                          /* V13 */
    -32768,                         /* W13 */
    65535,                          /* V14 */
    -32768,                         /* W14 */
    65535,                          /* V15 */
    -32768,                         /* W15 */
    65535,                          /* V16 */
    -32768,                         /* W16 */
    65535,                          /* V17 */
    -32768,                         /* W17 */
    65535,                          /* V18 */
    -32768,                         /* W18 */
    65535,                          /* V19 */
    -32768,                         /* W19 */
    65535,                          /* V20 */
    -32768,                         /* W20 */
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,     /* CrvNam -  */
    340,                            /* RmpPt1Tms */
    350,                            /* RmpDecTmm */
    360,                            /* RmpIncTmm */
    0,                              /* ReadOnly */
    3,                              /* ActPt */
    2,                              /* DeptRef */
    1000,                           /* V1 */
    100,                            /* W1 */
    1100,                           /* V2 */
    100,                            /* W2 */
    1130,                           /* V3 */
    0,                              /* W3 */
    65535,                          /* V4 */
    -32768,                         /* W4 */
    65535,                          /* V5 */
    -32768,                         /* W5 */
    65535,                          /* V6 */
    -32768,                         /* W6 */
    65535,                          /* V7 */
    -32768,                         /* W7 */
    65535,                          /* V8 */
    -32768,                         /* W8 */
    65535,                          /* V9 */
    -32768,                         /* W9 */
    65535,                          /* V10 */
    -32768,                         /* W10 */
    65535,                          /* V11 */
    -32768,                         /* W11 */
    65535,                          /* V12 */
    -32768,                         /* W12 */
    65535,                          /* V13 */
    -32768,                         /* W13 */
    65535,                          /* V14 */
    -32768,                         /* W14 */
    65535,                          /* V15 */
    -32768,                         /* W15 */
    65535,                          /* V16 */
    -32768,                         /* W16 */
    65535,                          /* V17 */
    -32768,                         /* W17 */
    65535,                          /* V18 */
    -32768,                         /* W18 */
    65535,                          /* V19 */
    -32768,                         /* W19 */
    65535,                          /* V20 */
    -32768,                         /* W20 */
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,     /* CrvNam -  */
    65535,                          /* RmpPt1Tms */
    80,                             /* RmpDecTmm */
    80,                             /* RmpIncTmm */
    0,                              /* ReadOnly */
    3,                              /* ActPt */
    2,                              /* DeptRef */
    1000,                           /* V1 */
    100,                            /* W1 */
    1100,                           /* V2 */
    100,                            /* W2 */
    1130,                           /* V3 */
    0,                              /* W3 */
    65535,                          /* V4 */
    -32768,                         /* W4 */
    65535,                          /* V5 */
    -32768,                         /* W5 */
    65535,                          /* V6 */
    -32768,                         /* W6 */
    65535,                          /* V7 */
    -32768,                         /* W7 */
    65535,                          /* V8 */
    -32768,                         /* W8 */
    65535,                          /* V9 */
    -32768,                         /* W9 */
    65535,                          /* V10 */
    -32768,                         /* W10 */
    65535,                          /* V11 */
    -32768,                         /* W11 */
    65535,                          /* V12 */
    -32768,                         /* W12 */
    65535,                          /* V13 */
    -32768,                         /* W13 */
    65535,                          /* V14 */
    -32768,                         /* W14 */
    65535,                          /* V15 */
    -32768,                         /* W15 */
    65535,                          /* V16 */
    -32768,                         /* W16 */
    65535,                          /* V17 */
    -32768,                         /* W17 */
    65535,                          /* V18 */
    -32768,                         /* W18 */
    65535,                          /* V19 */
    -32768,                         /* W19 */
    65535,                          /* V20 */
    -32768,                         /* W20 */
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,     /* CrvNam -  */
    65535,                          /* RmpPt1Tms */
    80,                             /* RmpDecTmm */
    80,                             /* RmpIncTmm */
    0,                              /* ReadOnly */

    /* model 134 */
    134, 242,
    1,                              /* ActCrv */
    0,                              /* ModEna */
    404,                            /* WinTms */
    504,                            /* RvrtTms */
    604,                            /* RmpTms */
    4,                              /* NCrv */
    4,                              /* NPt */
    -1,                             /* HZ_SF */
    -1,                             /* W_SF */
    0,                              /* RmpIncDec_SF */
    4,                              /* ActPt */
    980,                            /* HZ1 */
    1000,                           /* W1 */
    991,                            /* HZ2 */
    1001,                           /* W2 */
    992,                            /* HZ3 */
    1002,                           /* W3 */
    993,                            /* HZ4 */
    1003,                           /* W4 */
    65535,                          /* HZ5 */
    -32768,                         /* W5 */
    65535,                          /* HZ6 */
    -32768,                         /* W6 */
    65535,                          /* HZ7 */
    -32768,                         /* W7 */
    65535,                          /* HZ8 */
    -32768,                         /* W8 */
    65535,                          /* HZ9 */
    -32768,                         /* W9 */
    65535,                          /* HZ10 */
    -32768,                         /* W10 */
    65535,                          /* HZ11 */
    -32768,                         /* W11 */
    65535,                          /* HZ12 */
    -32768,                         /* W12 */
    65535,                          /* HZ13 */
    -32768,                         /* W13 */
    65535,                          /* HZ14 */
    -32768,                         /* W14 */
    65535,                          /* HZ15 */
    -32768,                         /* W15 */
    65535,                          /* HZ16 */
    -32768,                         /* W16 */
    65535,                          /* HZ17 */
    -32768,                         /* W17 */
    65535,                          /* HZ18 */
    -32768,                         /* W18 */
    65535,                          /* HZ19 */
    -32768,                         /* W19 */
    65535,                          /* HZ20 */
    -32768,                         /* W20 */
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,     /* CrvNam -  */
    104,                            /* RmpPt1Tms */
    204,                            /* RmpDecTmm */
    304,                            /* RmpIncTmm */
    404,                            /* RmpRsUp */
    0,                              /* SnptW */
    5040,                           /* WRef */
    6040,                           /* WRefStrHz */
    7040,                           /* WRefStopHz */
    0,                              /* ReadOnly */
    4,                              /* ActPt */
    990,                            /* HZ1 */
    1000,                           /* W1 */
    991,                            /* HZ2 */
    1001,                           /* W2 */
    992,                            /* HZ3 */
    1002,                           /* W3 */
    993,                            /* HZ4 */
    1003,                           /* W4 */
    65535,                          /* HZ5 */
    -32768,                         /* W5 */
    65535,                          /* HZ6 */
    -32768,                         /* W6 */
    65535,                          /* HZ7 */
    -32768,                         /* W7 */
    65535,                          /* HZ8 */
    -32768,                         /* W8 */
    65535,                          /* HZ9 */
    -32768,                         /* W9 */
    65535,                          /* HZ10 */
    -32768,                         /* W10 */
    65535,                          /* HZ11 */
    -32768,                         /* W11 */
    65535,                          /* HZ12 */
    -32768,                         /* W12 */
    65535,                          /* HZ13 */
    -32768,                         /* W13 */
    65535,                          /* HZ14 */
    -32768,                         /* W14 */
    65535,                          /* HZ15 */
    -32768,                         /* W15 */
    65535,                          /* HZ16 */
    -32768,                         /* W16 */
    65535,                          /* HZ17 */
    -32768,                         /* W17 */
    65535,                          /* HZ18 */
    -32768,                         /* W18 */
    65535,                          /* HZ19 */
    -32768,                         /* W19 */
    65535,                          /* HZ20 */
    -32768,                         /* W20 */
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,     /* CrvNam -  */
    65535,                          /* RmpPt1Tms */
    65535,                          /* RmpDecTmm */
    65535,                          /* RmpIncTmm */
    65535,                          /* RmpRsUp */
    0,                              /* SnptW */
    65535,                          /* WRef */
    65535,                          /* WRefStrHz */
    65535,                          /* WRefStopHz */
    0,                              /* ReadOnly */
    4,                              /* ActPt */
    990,                            /* HZ1 */
    1000,                           /* W1 */
    991,                            /* HZ2 */
    1001,                           /* W2 */
    992,                            /* HZ3 */
    1002,                           /* W3 */
    993,                            /* HZ4 */
    1003,                           /* W4 */
    65535,                          /* HZ5 */
    -32768,                         /* W5 */
    65535,                          /* HZ6 */
    -32768,                         /* W6 */
    65535,                          /* HZ7 */
    -32768,                         /* W7 */
    65535,                          /* HZ8 */
    -32768,                         /* W8 */
    65535,                          /* HZ9 */
    -32768,                         /* W9 */
    65535,                          /* HZ10 */
    -32768,                         /* W10 */
    65535,                          /* HZ11 */
    -32768,                         /* W11 */
    65535,                          /* HZ12 */
    -32768,                         /* W12 */
    65535,                          /* HZ13 */
    -32768,                         /* W13 */
    65535,                          /* HZ14 */
    -32768,                         /* W14 */
    65535,                          /* HZ15 */
    -32768,                         /* W15 */
    65535,                          /* HZ16 */
    -32768,                         /* W16 */
    65535,                          /* HZ17 */
    -32768,                         /* W17 */
    65535,                          /* HZ18 */
    -32768,                         /* W18 */
    65535,                          /* HZ19 */
    -32768,                         /* W19 */
    65535,                          /* HZ20 */
    -32768,                         /* W20 */
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,     /* CrvNam -  */
    65535,                          /* RmpPt1Tms */
    65535,                          /* RmpDecTmm */
    65535,                          /* RmpIncTmm */
    65535,                          /* RmpRsUp */
    0,                              /* SnptW */
    65535,                          /* WRef */
    65535,                          /* WRefStrHz */
    65535,                          /* WRefStopHz */
    0,                              /* ReadOnly */
    4,                              /* ActPt */
    990,                            /* HZ1 */
    1000,                           /* W1 */
    991,                            /* HZ2 */
    1001,                           /* W2 */
    992,                            /* HZ3 */
    1002,                           /* W3 */
    993,                            /* HZ4 */
    1003,                           /* W4 */
    65535,                          /* HZ5 */
    -32768,                         /* W5 */
    65535,                          /* HZ6 */
    -32768,                         /* W6 */
    65535,                          /* HZ7 */
    -32768,                         /* W7 */
    65535,                          /* HZ8 */
    -32768,                         /* W8 */
    65535,                          /* HZ9 */
    -32768,                         /* W9 */
    65535,                          /* HZ10 */
    -32768,                         /* W10 */
    65535,                          /* HZ11 */
    -32768,                         /* W11 */
    65535,                          /* HZ12 */
    -32768,                         /* W12 */
    65535,                          /* HZ13 */
    -32768,                         /* W13 */
    65535,                          /* HZ14 */
    -32768,                         /* W14 */
    65535,                          /* HZ15 */
    -32768,                         /* W15 */
    65535,                          /* HZ16 */
    -32768,                         /* W16 */
    65535,                          /* HZ17 */
    -32768,                         /* W17 */
    65535,                          /* HZ18 */
    -32768,                         /* W18 */
    65535,                          /* HZ19 */
    -32768,                         /* W19 */
    65535,                          /* HZ20 */
    -32768,                         /* W20 */
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,     /* CrvNam -  */
    65535,                          /* RmpPt1Tms */
    65535,                          /* RmpDecTmm */
    65535,                          /* RmpIncTmm */
    65535,                          /* RmpRsUp */
    0,                              /* SnptW */
    65535,                          /* WRef */
    65535,                          /* WRefStrHz */
    65535,                          /* WRefStopHz */
    0,                              /* ReadOnly */

    0xffff, 0                       /* end model id and length */
};

uint16_t test_device_63001[] = {
    0x5375, 0x6e53,                 /* SunS */
    /* model 1 */
    1, 66,
    0x5375, 0x6e53, 0x7065, 0x6354, 0x6573, 0x7400, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,     /* Mn - SunSpecTest */
    0x5465, 0x7374, 0x4465, 0x7669, 0x6365, 0x2d31, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,     /* Md - TestDevice-1 */
    0x6f70, 0x745f, 0x615f, 0x625f, 0x6300, 0x0000, 0x0000, 0x0000,     /* Opt - opt_a_b_c */
    0x312e, 0x322e, 0x3300, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,     /* Vr - 1.2.3 */
    0x736e, 0x2d31, 0x3233, 0x3435, 0x3637, 0x3839, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,     /* SN - sn-123456789 */
    1,                              /* DA */
    -32768,                         /* Pad */
    /* model 63001 */
    63001, 188,
    -10,                            /* sunssf_1 */
    10,                             /* sunssf_2 */
    0,                              /* sunssf_3 */
    1,                              /* sunssf_4 */
    1,                              /* int16_1 */
    -1,                             /* int16_2 */
    2,                              /* int16_3 */
    -2,                             /* int16_4 */
    3,                              /* int16_5 */
    -32768,                         /* int16_u */
    4,                              /* uint16_1 */
    5,                              /* uint16_2 */
    65524,                          /* uint16_3 */
    6,                              /* uint16_4 */
    7,                              /* uint16_5 */
    65535,                          /* uint16_u */
    8,                              /* acc16 */
    0,                              /* acc16_u */
    9,                              /* enum16 */
    65535,                          /* enum16_u */
    10,                             /* bitfield16 */
    65535,                          /* bitfield16_u */
    0x0000, 0x000b,                 /* int32_1  (11) */
    0x0000, 0x000c,                 /* int32_2  (12) */
    0x0000, 0x000d,                 /* int32_3  (13) */
    0x0000, 0x000e,                 /* int32_4  (14) */
    0x0000, 0x000f,                 /* int32_5  (15) */
    0x8000, 0x0000,                 /* int32_u  (-2147483648) */
    0x0000, 0x0010,                 /* uint32_1  (16) */
    0x0000, 0x0011,                 /* uint32_2  (17) */
    0x0000, 0x0012,                 /* uint32_3  (18) */
    0x0000, 0x0013,                 /* uint32_4  (19) */
    0x0000, 0x0014,                 /* uint32_5  (20) */
    0xffff, 0xffff,                 /* uint32_u  (4294967295) */
    0x0000, 0x0015,                 /* acc32  (21) */
    0x0000, 0x0000,                 /* acc32_u  (0) */
    0x0000, 0x0016,                 /* enum32  (22) */
    0xffff, 0xffff,                 /* enum32_u  (4294967295) */
    0x0000, 0x0017,                 /* bitfield32  (23) */
    0xffff, 0xffff,                 /* bitfield32_u  (4294967295) */
    0x0102, 0x0304,                 /* ipaddr  (16909060) */
    0x0000, 0x0000,                 /* ipaddr_u  (0) */
    0x0000, 0x0000, 0x0000, 0x0018, /* int64  (24) */
    0x8000, 0x0000, 0x0000, 0x0000, /* int64_u  (-9223372036854775808) */
    0x0000, 0x0000, 0x0000, 0x0019, /* acc64  (25) */
    0x0000, 0x0000, 0x0000, 0x0000, /* acc64_u  (0) */
    0, 0, 0, 0, 0, 0, 0, 0,         /* ipv6addr 8 */
    0, 0, 0, 0, 0, 0, 0, 0,         /* ipv6addr_u 8 */
    0x41D0, 0x0000,                 /* float32  (26) */
    // 0x0000, 0x001a,                 /* float32  (26) */
    0x7fc0, 0x0000,                 /* float32_u  (2143289344) */
    0x3132, 0x3334, 0x3536, 0x3738, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,     /* string - 12345678 */
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,     /* string_u -  */
    2,                              /* sunssf_5 */
    3,                              /* sunssf_6 */
    4,                              /* sunssf_7 */
    -32768,                         /* pad_1 */
    -2,                             /* sunssf_8 */
    30,                             /* int16_11 */
    31,                             /* int16_12 */
    -32768,                         /* int16_u */
    32,                             /* uint16_11 */
    33,                             /* uint16_12 */
    34,                             /* uint16_13 */
    65535,                          /* uint16_u */
    0x0000, 0x0023,                 /* int32  (35) */
    0x8000, 0x0000,                 /* int32_u  (-2147483648) */
    0x0000, 0x0024,                 /* uint32  (36) */
    0xffff, 0xffff,                 /* uint32_u  (4294967295) */
    -3,                             /* sunssf_9 */
    -32768,                         /* pad_2 */
    -4,                             /* sunssf_8 */
    40,                             /* int16_11 */
    41,                             /* int16_12 */
    -32768,                         /* int16_u */
    42,                             /* uint16_11 */
    43,                             /* uint16_12 */
    44,                             /* uint16_13 */
    65535,                          /* uint16_u */
    0x0000, 0x002d,                 /* int32  (45) */
    0x8000, 0x0000,                 /* int32_u  (-2147483648) */
    0x0000, 0x002e,                 /* uint32  (46) */
    0xffff, 0xffff,                 /* uint32_u  (4294967295) */
    -5,                             /* sunssf_9 */
    -32768,                         /* pad_2 */
    2,                              /* sunssf_8 */
    50,                             /* int16_11 */
    51,                             /* int16_12 */
    -32768,                         /* int16_u */
    52,                             /* uint16_11 */
    53,                             /* uint16_12 */
    54,                             /* uint16_13 */
    65535,                          /* uint16_u */
    0x0000, 0x0037,                 /* int32  (55) */
    0x8000, 0x0000,                 /* int32_u  (-2147483648) */
    0x0000, 0x0038,                 /* uint32  (56) */
    0xffff, 0xffff,                 /* uint32_u  (4294967295) */
    3,                              /* sunssf_9 */
    -32768,                         /* pad_2 */

    0xffff, 0                       /* end model id and length */

};

uint16_t test_device_len = sizeof(test_device);

void
test_suns_log(CuTest* tc)
{
    suns_log(SUNS_LOG_INFO, "test");
}

void
test_suns_model_def(CuTest* tc)
{
    suns_model_def_t *model_def = NULL;

    model_def = suns_model_def_get(63001);
    CuAssertTrue(tc, model_def != NULL);
    // suns_model_def_dump(model_def, "");
    model_def = suns_model_def_get(63002);
    CuAssertTrue(tc, model_def != NULL);
}

void
test_suns_device_sim(CuTest* tc)
{
    suns_device_t *device;
    suns_err_t err;
    unsigned char buf[256];

    suns_model_t *model;
    char *point_str;

    device = suns_device_alloc();
    CuAssertTrue(tc, device != NULL);
    err = suns_device_sim(device, 40000, test_device, sizeof(test_device), 1);
    CuAssertTrue(tc, err == SUNS_ERR_OK);
    err = suns_device_modbus_read(device, 40000, 2, buf, 0);
    CuAssertTrue(tc, err == SUNS_ERR_OK && buf[0] == 'S' && buf[1] == 'u' && buf[2] == 'n' && buf[3] == 'S');
    err = suns_device_scan(device);
    printf("base_addr = %d\n", device->base_addr);
    CuAssertTrue(tc, err == SUNS_ERR_OK);
 
    model = device->models;
    while (model) {
        err = suns_model_read(model);
        CuAssertTrue(tc, err == SUNS_ERR_OK);

        if (model->id == 1) {
            err = suns_model_point_get_str(model, "Mn", 0, &point_str);
            if (err == SUNS_ERR_OK) {
                printf("Mn = %s\n", point_str);
            } else {
                CuAssertTrue(tc, err == SUNS_ERR_OK);
            }
        }

        model = model->next;
    }

    err = (device->modbus_io.close)(&device->modbus_io);
    CuAssertTrue(tc, err == SUNS_ERR_OK);
}

void
test_suns_modbus_value(CuTest* tc)
{
    unsigned char buf[8];
    unsigned char buf16[2] = {0x80, 0x10};
    unsigned char buf32[4] = {0xBF, 0x9D, 0xF3, 0xB6};
    unsigned char buf64[8] = {0xBF, 0xF3, 0xBE, 0x76, 0xC8, 0xB4, 0x39, 0x58};
    unsigned char buftest[16] = {'T','e','s','t',' ','S','t','r','i','n','g',0,0,0,0,0};
    char bufstr[16];
    char buftmp[64];
    int16_t s16 = -32752;
    uint16_t u16 = 32784;
    int32_t s32 = -1080167498L;
    uint32_t u32 = 3214799798L;
    int64_t s64 = -4615135775741953704LL;
    uint64_t u64 = 13831608297967597912LL;
    float f32 = -1.234;
    double f64 = -1.234;
    suns_value_t value;

    suns_modbus_to_int16(buf16, &value, 0);
    CuAssertTrue(tc, value.s16 == s16);
    suns_modbus_to_uint16(buf16, &value, 0);
    CuAssertTrue(tc, value.u16 == u16);
    suns_modbus_to_int32(buf32, &value, 0);
    CuAssertTrue(tc, value.s32 == s32);
    suns_modbus_to_uint32(buf32, &value, 0);
    CuAssertTrue(tc, value.u32 == u32);
    suns_modbus_to_int64(buf64, &value, 0);
    CuAssertTrue(tc, value.s64 == s64);
    suns_modbus_to_uint64(buf64, &value, 0);
    CuAssertTrue(tc, value.u64 == u64);
    suns_modbus_to_float(buf32, &value, 0);
    CuAssertTrue(tc, value.f32 == f32);
    suns_modbus_to_double(buf64, &value, 0);
    CuAssertTrue(tc, value.f64 == f64);
    value.str = (char *) bufstr;
    memset(value.str, 0, 16);
    suns_modbus_to_str(buftest, &value, 16);
    CuAssertTrue(tc, memcmp(value.str, buftest, 16) == 0);

    memset(buf, 0, 8);
    value.s16 = s16;
    suns_modbus_from_int16(buf, value, 0);
    CuAssertTrue(tc, memcmp(buf, buf16, 2) == 0);
    memset(buf, 0, 8);
    value.u16 = u16;
    suns_modbus_from_uint16(buf, value, 0);
    CuAssertTrue(tc, memcmp(buf, buf16, 2) == 0);
    memset(buf, 0, 8);
    value.s32 = s32;
    suns_modbus_from_int32(buf, value, 0);
    CuAssertTrue(tc, memcmp(buf, buf32, 4) == 0);
    memset(buf, 0, 8);
    value.u32 = u32;
    suns_modbus_from_uint32(buf, value, 0);
    CuAssertTrue(tc, memcmp(buf, buf32, 4) == 0);
    memset(buf, 0, 8);
    value.s64 = s64;
    suns_modbus_from_int64(buf, value, 0);
    CuAssertTrue(tc, memcmp(buf, buf64, 8) == 0);
    memset(buf, 0, 8);
    value.u64 = u64;
    suns_modbus_from_uint64(buf, value, 0);
    CuAssertTrue(tc, memcmp(buf, buf64, 8) == 0);
    memset(buf, 0, 8);
    value.f32 = f32;
    suns_modbus_from_float(buf, value, 0);
    CuAssertTrue(tc, memcmp(buf, buf32, 4) == 0);
    memset(buf, 0, 8);
    value.f64 = f64;
    suns_modbus_from_double(buf, value, 0);
    CuAssertTrue(tc, memcmp(buf, buf64, 8) == 0);
    value.str = (char *) buftest;
    memset(buftmp, 0, 16);
    suns_modbus_from_str((unsigned char *) buftmp, value, 16);
    CuAssertTrue(tc, memcmp(buftest, buftmp, 16) == 0);
}

void
test_test_device_63001(CuTest* tc)
{
    suns_device_t *device;
    suns_device_t *device_test;
    suns_err_t err;
    unsigned char buf[256];

    suns_model_t *model;
    char *point_str;

    device = suns_device_alloc();
    CuAssertTrue(tc, device != NULL);
    err = suns_device_sim(device, 40000, test_device_63001, sizeof(test_device_63001), 1);
    CuAssertTrue(tc, err == SUNS_ERR_OK);
    err = suns_device_modbus_read(device, 40000, 2, buf, 0);
    CuAssertTrue(tc, err == SUNS_ERR_OK && buf[0] == 'S' && buf[1] == 'u' && buf[2] == 'n' && buf[3] == 'S');
    err = suns_device_scan(device);
    printf("base_addr = %d  err = %d\n", device->base_addr, err);
    CuAssertTrue(tc, err == SUNS_ERR_OK);

    model = device->models;
    while (model) {
        err = suns_model_read(model);
        CuAssertTrue(tc, err == SUNS_ERR_OK);

        if (model->id == 1) {
            err = suns_model_point_get_str(model, "Mn", 0, &point_str);
            if (err == SUNS_ERR_OK) {
                printf("Mn = %s\n", point_str);
            } else {
                CuAssertTrue(tc, err == SUNS_ERR_OK);
            }
        }

        model = model->next;
    }
    suns_device_dump(device, "Device dump:\n");

    device_test = suns_device_alloc();
    err = suns_model_add(device_test, 1, 66, 2, &model);
    CuAssertTrue(tc, err == SUNS_ERR_OK);
    err = suns_model_point_set_str(model, "Mn", 0, "Manufacturer") ||
          suns_model_point_set_str(model, "Md", 0, "Model") ||
          suns_model_point_set_str(model, "Opt", 0, "Options") ||
          suns_model_point_set_str(model, "Vr", 0, "Version") ||
          suns_model_point_set_str(model, "SN", 0, "sn-1234");
    CuAssertTrue(tc, err == SUNS_ERR_OK);
    err = suns_model_add(device_test, 63001, 188, 68, &model);
    CuAssertTrue(tc, err == SUNS_ERR_OK);
    // suns_device_dump(device_test, "Device dump:\n");

    err = (device->modbus_io.close)(&device->modbus_io);
    CuAssertTrue(tc, err == SUNS_ERR_OK);
}

void
test_suns_point_value_equals(CuTest* tc)
{
    suns_point_def_t pd1;
    suns_point_def_t pd2;
    suns_point_def_t sfpd;
    suns_point_t p1;
    suns_point_t p2;
    suns_point_t sfp1;
    suns_point_t sfp2;
    char str1[16] = {'T','e','s','t',' ','S','t','r','i','n','g',0,0,0,0,0};
    char str2[16] = {'T','e','s','t',' ','S','t','r','i','n','g',0,0,0,0,0};

    pd1.type = suns_data_type_find("int32");
    pd1.id = "test point";
    pd2.type = suns_data_type_find("uint32");
    pd2.id = "test point";
    sfpd.type = suns_data_type_find("sunssf");

    sfp1.point_def = &sfpd;
    sfp1.sf_point = NULL;
    sfp1.value_base.s16 = 1;

    sfp2.point_def = &sfpd;
    sfp2.sf_point = NULL;
    sfp2.value_base.s16 = 2;

    p1.point_def = &pd1;
    p1.sf_point = &sfp1;
    p1.value_base.u32 = 1;

    p2.point_def = &pd1;
    p2.sf_point = &sfp1;
    p2.value_base.u32 = 1;

    CuAssertTrue(tc, suns_point_value_equals(&p1, &p2));

    /* should fail on type */
    p2.point_def = &pd2;
    CuAssertTrue(tc, !suns_point_value_equals(&p1, &p2));
    p2.point_def = &pd1;

    /* should fail on sf point differences */
    p1.sf_point = NULL;
    CuAssertTrue(tc, !suns_point_value_equals(&p1, &p2));
    p1.sf_point = &sfp1;
    p2.sf_point = NULL;
    CuAssertTrue(tc, !suns_point_value_equals(&p1, &p2));
    p2.sf_point = &sfp1;

    /* should fail on sf point value difference */
    p2.sf_point = &sfp2;
    CuAssertTrue(tc, !suns_point_value_equals(&p1, &p2));
    p2.sf_point = &sfp1;

    p2.value_base.u32 = 1;
    CuAssertTrue(tc, suns_point_value_equals(&p1, &p2));

    pd1.type = suns_data_type_find("string");
    pd1.len = 8;
    pd2.type = suns_data_type_find("string");
    pd2.len = 8;

    p1.point_def = &pd1;
    p1.sf_point = NULL;
    p1.value_ptr = str1;
    p1.value_base.str = p1.value_ptr;

    p2.point_def = &pd2;
    p2.sf_point = NULL;
    p2.value_ptr = str2;
    p2.value_base.str = p2.value_ptr;

    CuAssertTrue(tc, suns_point_value_equals(&p1, &p2));

    pd2.len = 9;
    CuAssertTrue(tc, !suns_point_value_equals(&p1, &p2));
    pd2.len = 8;

    str1[15] = 0x01;
    CuAssertTrue(tc, !suns_point_value_equals(&p1, &p2));
    str1[15] = 0;

    CuAssertTrue(tc, suns_point_value_equals(&p1, &p2));    
}

void
test_suns_device_get_model(CuTest* tc)
{
    suns_device_t *device;
    suns_err_t err;

    suns_model_t *model_1;
    suns_model_t *model_common;
    // suns_point_t *point;
    // char *point_str;

    device = suns_device_alloc();
    CuAssertTrue(tc, device != NULL);
    err = suns_device_sim(device, 40000, test_device_63001, sizeof(test_device_63001), 1);
    CuAssertTrue(tc, err == SUNS_ERR_OK);
    err = suns_device_scan(device);
    printf("base_addr = %d  err = %d\n", device->base_addr, err);
    CuAssertTrue(tc, err == SUNS_ERR_OK);

    model_1 = suns_device_get_model(device, 1, NULL, 1);
    CuAssertTrue(tc, model_1 != NULL);
    model_common = suns_device_get_model(device, 1, NULL, 1);
    CuAssertTrue(tc, model_common != NULL);
    CuAssertTrue(tc, model_1 == model_common);

    err = (device->modbus_io.close)(&device->modbus_io);
    CuAssertTrue(tc, err == SUNS_ERR_OK);
}

void
test_point_get_set(CuTest* tc)
{
    suns_device_t *device;
    suns_err_t err;
    suns_model_t *model;
    char *point_str;
    int16_t sf;
    int16_t s16;
    uint16_t u16;
    int32_t s32;
    uint32_t u32;
    int64_t s64;
    float f32;

    device = suns_device_alloc();
    CuAssertTrue(tc, device != NULL);
    err = suns_device_sim(device, 40000, test_device_63001, sizeof(test_device_63001), 1);
    CuAssertTrue(tc, err == SUNS_ERR_OK);
    err = suns_device_scan(device);
    printf("base_addr = %d  err = %d\n", device->base_addr, err);
    CuAssertTrue(tc, err == SUNS_ERR_OK);

    model = suns_device_get_model(device, 1, NULL, 1);
    err = suns_model_read(model);
    CuAssertTrue(tc, err == SUNS_ERR_OK);

    err = suns_model_point_get_str(model, "Mn", 0, &point_str);
    CuAssertTrue(tc, err == SUNS_ERR_OK);
    CuAssertTrue(tc, strcmp(point_str, "SunSpecTest") == 0);
    err = suns_model_point_set_str(model, "Mn", 0, "Mn string");
    CuAssertTrue(tc, err == SUNS_ERR_OK);
    err = suns_model_point_get_str(model, "Mn", 0, &point_str);
    CuAssertTrue(tc, err == SUNS_ERR_OK);
    CuAssertTrue(tc, strcmp(point_str, "Mn string") == 0);

    model = suns_device_get_model(device, 63001, NULL, 1);
    err = suns_model_read(model);
    CuAssertTrue(tc, err == SUNS_ERR_OK);

    err = suns_model_point_get_int16(model, "int16_4", 0, &s16, &sf);
    CuAssertTrue(tc, err == SUNS_ERR_OK);
    printf("u16 = %d sf = %d\n", s16, sf);
    CuAssertTrue(tc, s16 == -2 && sf == 1);
    err = suns_model_point_set_int16(model, "int16_4", 0, -3, sf);
    CuAssertTrue(tc, err == SUNS_ERR_OK);
    err = suns_model_point_get_int16(model, "int16_4", 0, &s16, &sf);
    CuAssertTrue(tc, err == SUNS_ERR_OK);
    CuAssertTrue(tc, s16 == -3 && sf == 1);
    err = suns_model_point_get_int16(model, "int16_11", 1, &s16, &sf);
    CuAssertTrue(tc, err == SUNS_ERR_OK);
    printf("u16 = %d sf = %d\n", s16, sf);
    CuAssertTrue(tc, s16 == 30 && sf == -2);
    err = suns_model_point_set_int16(model, "int16_11", 1, 60, sf);
    CuAssertTrue(tc, err == SUNS_ERR_OK);
    err = suns_model_point_get_int16(model, "int16_11", 1, &s16, &sf);
    CuAssertTrue(tc, err == SUNS_ERR_OK);
    CuAssertTrue(tc, s16 == 60 && sf == -2);
    err = suns_model_point_get_int16(model, "int16_11", 3, &s16, &sf);
    CuAssertTrue(tc, err == SUNS_ERR_OK);
    CuAssertTrue(tc, s16 == 50 && sf == 2);
    err = suns_model_point_set_int16(model, "int16_11", 3, 60, sf);
    CuAssertTrue(tc, err == SUNS_ERR_OK);
    err = suns_model_point_get_int16(model, "int16_11", 3, &s16, &sf);
    CuAssertTrue(tc, err == SUNS_ERR_OK);
    CuAssertTrue(tc, s16 == 60 && sf == 2);
    err = suns_model_point_get_uint16(model, "uint16_1", 0, &u16, &sf);
    CuAssertTrue(tc, err == SUNS_ERR_OK);
    CuAssertTrue(tc, u16 == 4 && sf == -10);
    err = suns_model_point_set_uint16(model, "uint16_1", 0, 40, sf);
    CuAssertTrue(tc, err == SUNS_ERR_OK);
    err = suns_model_point_get_uint16(model, "uint16_1", 0, &u16, &sf);
    CuAssertTrue(tc, err == SUNS_ERR_OK);
    CuAssertTrue(tc, u16 == 40 && sf == -10);
    err = suns_model_point_get_int32(model, "int32_1", 0, &s32, &sf);
    CuAssertTrue(tc, err == SUNS_ERR_OK);
    CuAssertTrue(tc, s32 == 11 && sf == 2);
    err = suns_model_point_set_int32(model, "int32_1", 0, 110, sf);
    CuAssertTrue(tc, err == SUNS_ERR_OK);
    err = suns_model_point_get_int32(model, "int32_1", 0, &s32, &sf);
    CuAssertTrue(tc, err == SUNS_ERR_OK);
    CuAssertTrue(tc, s32 == 110 && sf == 2);
    err = suns_model_point_get_uint32(model, "uint32_1", 0, &u32, &sf);
    CuAssertTrue(tc, err == SUNS_ERR_OK);
    CuAssertTrue(tc, u32 == 16 && sf == 2);
    err = suns_model_point_set_uint32(model, "uint32_1", 0, 160, sf);
    CuAssertTrue(tc, err == SUNS_ERR_OK);
    err = suns_model_point_get_uint32(model, "uint32_1", 0, &u32, &sf);
    CuAssertTrue(tc, err == SUNS_ERR_OK);
    CuAssertTrue(tc, u32 == 160 && sf == 2);
    err = suns_model_point_get_int64(model, "int64", 0, &s64, &sf);
    CuAssertTrue(tc, err == SUNS_ERR_OK);
    CuAssertTrue(tc, s64 == 24 && sf == 0);
    err = suns_model_point_set_int64(model, "int64", 0, 240, sf);
    CuAssertTrue(tc, err == SUNS_ERR_OK);
    err = suns_model_point_get_int64(model, "int64", 0, &s64, &sf);
    CuAssertTrue(tc, err == SUNS_ERR_OK);
    CuAssertTrue(tc, s64 == 240 && sf == 0);
    err = suns_model_point_get_float32(model, "float32", 0, &f32);
    CuAssertTrue(tc, err == SUNS_ERR_OK);
    CuAssertTrue(tc, f32 == 26);
    err = suns_model_point_set_float32(model, "float32", 0, 260);
    CuAssertTrue(tc, err == SUNS_ERR_OK);
    err = suns_model_point_get_float32(model, "float32", 0, &f32);
    CuAssertTrue(tc, err == SUNS_ERR_OK);
    printf("********* f32 = %f", f32);
    CuAssertTrue(tc, f32 == 260);

    err = (device->modbus_io.close)(&device->modbus_io);
    CuAssertTrue(tc, err == SUNS_ERR_OK);
}

void
test_suns_model_write(CuTest* tc)
{
    suns_device_t *device;
    suns_err_t err;
    suns_model_t *model;
    int16_t sf;
    int16_t s16;
    uint16_t u16;
    int32_t s32;
    uint32_t u32;
    int64_t s64;
    float f32;

    device = suns_device_alloc();
    CuAssertTrue(tc, device != NULL);
    err = suns_device_sim(device, 40000, test_device_63001, sizeof(test_device_63001), 1);
    CuAssertTrue(tc, err == SUNS_ERR_OK);
    err = suns_device_scan(device);
    printf("base_addr = %d  err = %d\n", device->base_addr, err);
    CuAssertTrue(tc, err == SUNS_ERR_OK);

    model = suns_device_get_model(device, 63001, NULL, 1);
    err = suns_model_read(model);
    CuAssertTrue(tc, err == SUNS_ERR_OK);

    err = suns_model_point_get_int16(model, "int16_4", 0, &s16, &sf);
    CuAssertTrue(tc, err == SUNS_ERR_OK);
    printf("u16 = %d sf = %d\n", s16, sf);
    CuAssertTrue(tc, s16 == -2 && sf == 1);

    model = suns_device_get_model(device, 63001, NULL, 1);
    CuAssertTrue(tc, model != NULL);
    err = suns_model_read(model);
    CuAssertTrue(tc, err == SUNS_ERR_OK);

    err = suns_model_point_get_int16(model, "int16_1", 0, &s16, &sf);
    CuAssertTrue(tc, err == SUNS_ERR_OK);
    err = suns_model_point_set_int16(model, "int16_1", 0, -10, sf);
    CuAssertTrue(tc, err == SUNS_ERR_OK);
    err = suns_model_point_get_int16(model, "int16_2", 0, &s16, &sf);
    CuAssertTrue(tc, err == SUNS_ERR_OK);
    err = suns_model_point_set_int16(model, "int16_2", 0, -20, sf);
    CuAssertTrue(tc, err == SUNS_ERR_OK);
    err = suns_model_point_get_int16(model, "int16_3", 0, &s16, &sf);
    CuAssertTrue(tc, err == SUNS_ERR_OK);
    err = suns_model_point_set_int16(model, "int16_3", 0, -30, sf);
    CuAssertTrue(tc, err == SUNS_ERR_OK);
    err = suns_model_point_get_int16(model, "int16_4", 0, &s16, &sf);
    CuAssertTrue(tc, err == SUNS_ERR_OK);
    err = suns_model_point_set_int16(model, "int16_4", 0, -40, sf);
    CuAssertTrue(tc, err == SUNS_ERR_OK);
    err = suns_model_point_get_uint16(model, "uint16_1", 0, &u16, &sf);
    CuAssertTrue(tc, err == SUNS_ERR_OK);
    err = suns_model_point_set_uint16(model, "uint16_1", 0, 10, sf);
    CuAssertTrue(tc, err == SUNS_ERR_OK);
    err = suns_model_point_get_int32(model, "int32_1", 0, &s32, &sf);
    CuAssertTrue(tc, err == SUNS_ERR_OK);
    err = suns_model_point_set_int32(model, "int32_1", 0, -100, sf);
    CuAssertTrue(tc, err == SUNS_ERR_OK);
    err = suns_model_point_get_int32(model, "int32_2", 0, &s32, &sf);
    CuAssertTrue(tc, err == SUNS_ERR_OK);
    err = suns_model_point_set_int32(model, "int32_2", 0, -200, sf);
    CuAssertTrue(tc, err == SUNS_ERR_OK);
    err = suns_model_point_get_int32(model, "int32_3", 0, &s32, &sf);
    CuAssertTrue(tc, err == SUNS_ERR_OK);
    err = suns_model_point_set_int32(model, "int32_3", 0, -300, sf);
    CuAssertTrue(tc, err == SUNS_ERR_OK);
    err = suns_model_point_get_int32(model, "int32_4", 0, &s32, &sf);
    CuAssertTrue(tc, err == SUNS_ERR_OK);
    err = suns_model_point_set_int32(model, "int32_4", 0, -400, sf);
    CuAssertTrue(tc, err == SUNS_ERR_OK);
    err = suns_model_point_get_uint32(model, "uint32_1", 0, &u32, &sf);
    CuAssertTrue(tc, err == SUNS_ERR_OK);
    err = suns_model_point_set_uint32(model, "uint32_1", 0, 100, sf);
    CuAssertTrue(tc, err == SUNS_ERR_OK);
    err = suns_model_point_get_int64(model, "int64", 0, &s64, &sf);
    CuAssertTrue(tc, err == SUNS_ERR_OK);
    err = suns_model_point_set_int64(model, "int64", 0, 1000, sf);
    CuAssertTrue(tc, err == SUNS_ERR_OK);
    err = suns_model_point_get_float32(model, "float32", 0, &f32);
    CuAssertTrue(tc, err == SUNS_ERR_OK);
    err = suns_model_point_set_float32(model, "float32", 0, 2000);
    CuAssertTrue(tc, err == SUNS_ERR_OK);

    err = suns_model_write(model);
    CuAssertTrue(tc, err == SUNS_ERR_OK);
    err = suns_model_write(model);
    CuAssertTrue(tc, err == SUNS_ERR_OK);

    err = suns_model_point_get_int16(model, "int16_1", 0, &s16, &sf);
    CuAssertTrue(tc, err == SUNS_ERR_OK);
    CuAssertTrue(tc, s16 == -10);
    err = suns_model_point_get_int16(model, "int16_2", 0, &s16, &sf);
    CuAssertTrue(tc, err == SUNS_ERR_OK);
    CuAssertTrue(tc, s16 == -20);
    err = suns_model_point_get_int16(model, "int16_3", 0, &s16, &sf);
    CuAssertTrue(tc, err == SUNS_ERR_OK);
    CuAssertTrue(tc, s16 == -30);
    err = suns_model_point_get_int16(model, "int16_4", 0, &s16, &sf);
    CuAssertTrue(tc, err == SUNS_ERR_OK);
    CuAssertTrue(tc, s16 == -40);
    err = suns_model_point_get_uint16(model, "uint16_1", 0, &u16, &sf);
    CuAssertTrue(tc, err == SUNS_ERR_OK);
    CuAssertTrue(tc, u16 == 10);
    err = suns_model_point_get_int32(model, "int32_1", 0, &s32, &sf);
    CuAssertTrue(tc, err == SUNS_ERR_OK);
    CuAssertTrue(tc, s32 == -100);
    err = suns_model_point_get_int32(model, "int32_2", 0, &s32, &sf);
    CuAssertTrue(tc, err == SUNS_ERR_OK);
    CuAssertTrue(tc, s32 == -200);
    err = suns_model_point_get_int32(model, "int32_3", 0, &s32, &sf);
    CuAssertTrue(tc, err == SUNS_ERR_OK);
    CuAssertTrue(tc, s32 == -300);
    err = suns_model_point_get_int32(model, "int32_4", 0, &s32, &sf);
    CuAssertTrue(tc, err == SUNS_ERR_OK);
    CuAssertTrue(tc, s32 == -400);
    err = suns_model_point_get_uint32(model, "uint32_1", 0, &u32, &sf);
    CuAssertTrue(tc, err == SUNS_ERR_OK);
    CuAssertTrue(tc, u32 == 100);
    err = suns_model_point_get_int64(model, "int64", 0, &s64, &sf);
    CuAssertTrue(tc, err == SUNS_ERR_OK);
    CuAssertTrue(tc, s64 == 1000);
    err = suns_model_point_get_float32(model, "float32", 0, &f32);
    CuAssertTrue(tc, err == SUNS_ERR_OK);
    CuAssertTrue(tc, f32 == 2000);

    err = (device->modbus_io.close)(&device->modbus_io);
    CuAssertTrue(tc, err == SUNS_ERR_OK);
}

void
test_suns_to_float(CuTest* tc)
{
    int16_t sf;
    suns_value_t v;
    float f32;
    
    v.s16 = -20;
    sf = -2;
    suns_value_int16_to_float(v, sf, &f32);
    CuAssertTrue(tc, f32 == (float) -.2);
    sf = 0;
    suns_value_int16_to_float(v, sf, &f32);
    CuAssertTrue(tc, f32 == (float) -20);
    sf = 2;
    suns_value_int16_to_float(v, sf, &f32);
    CuAssertTrue(tc, f32 == (float) -2000);
    v.s32 = -30;
    sf = -2;
    suns_value_int32_to_float(v, sf, &f32);
    CuAssertTrue(tc, f32 == (float) -.3);
    sf = 0;
    suns_value_int32_to_float(v, sf, &f32);
    CuAssertTrue(tc, f32 == (float) -30);
    sf = 2;
    suns_value_int32_to_float(v, sf, &f32);
    CuAssertTrue(tc, f32 == (float) -3000);
    v.s64 = -40;
    sf = -2;
    suns_value_int64_to_float(v, sf, &f32);
    CuAssertTrue(tc, f32 == (float) -.4);
    sf = 0;
    suns_value_int64_to_float(v, sf, &f32);
    CuAssertTrue(tc, f32 == (float) -40);
    sf = 2;
    suns_value_int64_to_float(v, sf, &f32);
    CuAssertTrue(tc, f32 == (float) -4000);

    f32 = (float) -.5;
    // printf("f32 = %f\n", f32);
    suns_value_float_to_int16(&v, -2, f32);
    // printf("v.s16 = %d\n", v.s16);
    CuAssertTrue(tc, v.s16 == -50);
}

void
test_suns_float_conversion(CuTest* tc)
{
    suns_device_t *device;
    suns_err_t err;
    suns_model_t *model;
    int16_t sf;
    int16_t s16;
    uint16_t u16;
    int32_t s32;
    uint32_t u32;
    int64_t s64;
    float f32;

    device = suns_device_alloc();
    CuAssertTrue(tc, device != NULL);
    err = suns_device_sim(device, 40000, test_device_63001, sizeof(test_device_63001), 1);
    CuAssertTrue(tc, err == SUNS_ERR_OK);
    err = suns_device_scan(device);
    printf("base_addr = %d  err = %d\n", device->base_addr, err);
    CuAssertTrue(tc, err == SUNS_ERR_OK);

    model = suns_device_get_model(device, 63001, NULL, 1);
    CuAssertTrue(tc, model != NULL);
    err = suns_model_read(model);
    CuAssertTrue(tc, err == SUNS_ERR_OK);

    err = suns_model_point_get_int16(model, "int16_4", 0, &s16, &sf);
    CuAssertTrue(tc, err == SUNS_ERR_OK);
    err = suns_model_point_get_float32(model, "int16_4", 0, &f32);
    CuAssertTrue(tc, err == SUNS_ERR_OK);
    CuAssertTrue(tc, (s16 == -2) && (sf == 1) && (f32 == -20));
    err = suns_model_point_set_float32(model, "int16_4", 0, (float) -40);
    CuAssertTrue(tc, err == SUNS_ERR_OK);
    err = suns_model_point_get_int16(model, "int16_4", 0, &s16, &sf);
    CuAssertTrue(tc, err == SUNS_ERR_OK);
    err = suns_model_point_get_float32(model, "int16_4", 0, &f32);
    CuAssertTrue(tc, err == SUNS_ERR_OK);
    CuAssertTrue(tc, (s16 == -4) && (sf == 1) && (f32 == -40));

    err = suns_model_point_get_uint16(model, "uint16_4", 0, &u16, &sf);
    CuAssertTrue(tc, err == SUNS_ERR_OK);
    err = suns_model_point_get_float32(model, "uint16_4", 0, &f32);
    CuAssertTrue(tc, err == SUNS_ERR_OK);
    CuAssertTrue(tc, (u16 == 6) && (sf == 1) && (f32 == 60));
    err = suns_model_point_set_float32(model, "uint16_4", 0, (float) 10);
    CuAssertTrue(tc, err == SUNS_ERR_OK);
    err = suns_model_point_get_uint16(model, "uint16_4", 0, &u16, &sf);
    CuAssertTrue(tc, err == SUNS_ERR_OK);
    err = suns_model_point_get_float32(model, "uint16_4", 0, &f32);
    CuAssertTrue(tc, err == SUNS_ERR_OK);
    CuAssertTrue(tc, (u16 == 1) && (sf == 1) && (f32 == 10));

    err = suns_model_point_get_int32(model, "int32_3", 0, &s32, &sf);
    CuAssertTrue(tc, err == SUNS_ERR_OK);
    err = suns_model_point_get_float32(model, "int32_3", 0, &f32);
    CuAssertTrue(tc, err == SUNS_ERR_OK);
    CuAssertTrue(tc, (s32 == 13) && (sf == 4) && (f32 == 130000));
    err = suns_model_point_set_float32(model, "int32_3", 0, (float) -10000);
    CuAssertTrue(tc, err == SUNS_ERR_OK);
    err = suns_model_point_get_int32(model, "int32_3", 0, &s32, &sf);
    CuAssertTrue(tc, err == SUNS_ERR_OK);
    err = suns_model_point_get_float32(model, "int32_3", 0, &f32);
    CuAssertTrue(tc, err == SUNS_ERR_OK);
    CuAssertTrue(tc, (s32 == -1) && (sf == 4) && (f32 == -10000));

    err = suns_model_point_get_uint32(model, "uint32_2", 0, &u32, &sf);
    CuAssertTrue(tc, err == SUNS_ERR_OK);
    err = suns_model_point_get_float32(model, "uint32_2", 0, &f32);
    CuAssertTrue(tc, err == SUNS_ERR_OK);
    CuAssertTrue(tc, (u32 == 17) && (sf == 3) && (f32 == 17000));
    err = suns_model_point_set_float32(model, "uint32_2", 0, (float) 36000);
    CuAssertTrue(tc, err == SUNS_ERR_OK);
    err = suns_model_point_get_uint32(model, "uint32_2", 0, &u32, &sf);
    CuAssertTrue(tc, err == SUNS_ERR_OK);
    err = suns_model_point_get_float32(model, "uint32_2", 0, &f32);
    CuAssertTrue(tc, err == SUNS_ERR_OK);
    CuAssertTrue(tc, (u32 == 36) && (sf == 3) && (f32 == 36000));

    err = suns_model_point_get_int64(model, "int64", 0, &s64, &sf);
    CuAssertTrue(tc, err == SUNS_ERR_OK);
    err = suns_model_point_get_float32(model, "int64", 0, &f32);
    CuAssertTrue(tc, err == SUNS_ERR_OK);
    CuAssertTrue(tc, (s64 == 24) && (sf == 0) && (f32 == 24));
    err = suns_model_point_set_float32(model, "int64", 0, (float) 123000);
    CuAssertTrue(tc, err == SUNS_ERR_OK);
    err = suns_model_point_get_int64(model, "int64", 0, &s64, &sf);
    CuAssertTrue(tc, err == SUNS_ERR_OK);
    err = suns_model_point_get_float32(model, "int64", 0, &f32);
    CuAssertTrue(tc, err == SUNS_ERR_OK);
    CuAssertTrue(tc, (s64 == 123000) && (sf == 0) && (f32 == 123000));

    err = suns_model_point_get_float32(model, "float32", 0, &f32);
    CuAssertTrue(tc, err == SUNS_ERR_OK);
    CuAssertTrue(tc, f32 == 26);
    err = suns_model_point_set_float32(model, "float32", 0, 2000);
    CuAssertTrue(tc, err == SUNS_ERR_OK);
    err = suns_model_point_get_float32(model, "float32", 0, &f32);
    CuAssertTrue(tc, err == SUNS_ERR_OK);
    CuAssertTrue(tc, f32 == 2000);

    err = (device->modbus_io.close)(&device->modbus_io);
    CuAssertTrue(tc, err == SUNS_ERR_OK);
}

void
test_suns_implemented(CuTest* tc)
{
    suns_device_t *device;
    suns_err_t err;
    suns_model_t *model;

    device = suns_device_alloc();
    CuAssertTrue(tc, device != NULL);
    err = suns_device_sim(device, 40000, test_device_63001, sizeof(test_device_63001), 1);
    CuAssertTrue(tc, err == SUNS_ERR_OK);
    err = suns_device_scan(device);
    printf("base_addr = %d  err = %d\n", device->base_addr, err);
    CuAssertTrue(tc, err == SUNS_ERR_OK);

    model = suns_device_get_model(device, 63001, NULL, 1);
    CuAssertTrue(tc, model != NULL);
    err = suns_model_read(model);
    CuAssertTrue(tc, err == SUNS_ERR_OK);

    CuAssertTrue(tc, suns_model_point_is_implemented(model, "int16_1", 0) == 1);
    CuAssertTrue(tc, suns_model_point_is_implemented(model, "int16_u", 0) == 0);
    CuAssertTrue(tc, suns_model_point_is_implemented(model, "acc16", 0) == 1);
    CuAssertTrue(tc, suns_model_point_is_implemented(model, "enum16", 0) == 1);
    CuAssertTrue(tc, suns_model_point_is_implemented(model, "enum16_u", 0) == 0);
    CuAssertTrue(tc, suns_model_point_is_implemented(model, "bitfield16", 0) == 1);
    CuAssertTrue(tc, suns_model_point_is_implemented(model, "bitfield16_u", 0) == 0);
    CuAssertTrue(tc, suns_model_point_is_implemented(model, "int32_1", 0) == 1);
    CuAssertTrue(tc, suns_model_point_is_implemented(model, "int32_u", 0) == 0);
    CuAssertTrue(tc, suns_model_point_is_implemented(model, "uint32_1", 0) == 1);
    CuAssertTrue(tc, suns_model_point_is_implemented(model, "uint32_u", 0) == 0);
    CuAssertTrue(tc, suns_model_point_is_implemented(model, "acc32", 0) == 1);
    CuAssertTrue(tc, suns_model_point_is_implemented(model, "enum32", 0) == 1);
    CuAssertTrue(tc, suns_model_point_is_implemented(model, "enum32_u", 0) == 0);
    CuAssertTrue(tc, suns_model_point_is_implemented(model, "bitfield32", 0) == 1);
    CuAssertTrue(tc, suns_model_point_is_implemented(model, "bitfield32_u", 0) == 0);
    CuAssertTrue(tc, suns_model_point_is_implemented(model, "ipaddr", 0) == 1);
    CuAssertTrue(tc, suns_model_point_is_implemented(model, "ipaddr_u", 0) == 0);
    CuAssertTrue(tc, suns_model_point_is_implemented(model, "int64", 0) == 1);
    CuAssertTrue(tc, suns_model_point_is_implemented(model, "int64_u", 0) == 0);
    CuAssertTrue(tc, suns_model_point_is_implemented(model, "float32", 0) == 1);
    CuAssertTrue(tc, suns_model_point_is_implemented(model, "float32_u", 0) == 0);
}

void
test_suns_test_it(CuTest* tc)
{
}

/*-------------------------------------------------------------------------*
 * main
 *-------------------------------------------------------------------------*/

extern void test_inv();
extern void test_inv_freq_watt();
extern void test_inv_volt_var();
extern void test_inv_volt_watt();

CuSuite *
sunspec_suite(void)
{
    CuSuite *suite = CuSuiteNew();

    SUITE_ADD_TEST(suite, test_suns_log);
    SUITE_ADD_TEST(suite, test_suns_model_def);
    SUITE_ADD_TEST(suite, test_suns_device_sim);
    SUITE_ADD_TEST(suite, test_suns_modbus_value);
    SUITE_ADD_TEST(suite, test_test_device_63001);
    SUITE_ADD_TEST(suite, test_suns_point_value_equals);
    SUITE_ADD_TEST(suite, test_suns_device_get_model);
    SUITE_ADD_TEST(suite, test_point_get_set);
    SUITE_ADD_TEST(suite, test_suns_model_write);
    SUITE_ADD_TEST(suite, test_suns_to_float);
    SUITE_ADD_TEST(suite, test_suns_float_conversion);
    SUITE_ADD_TEST(suite, test_suns_implemented);
    SUITE_ADD_TEST(suite, test_inv_freq_watt);
    SUITE_ADD_TEST(suite, test_inv_volt_var);
    SUITE_ADD_TEST(suite, test_inv_volt_watt);
    SUITE_ADD_TEST(suite, test_inv);

    return suite;
}
